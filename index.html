<!DOCTYPE html>
<html lang="ht">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sante Mantal Ayisyen — Soutyen Emosyonèl</title>
    <style>
        :root {
            --bg1: #f8f9fa;
            --bg2: #e9ecef;
            --accent: #4e89ae;
            --accent-2: #4361ee;
            --muted: #6c757d;
            --card: #ffffff;
            --glass: rgba(255, 255, 255, 0.85);
            --radius: 12px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #2d3748;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 25px;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 30px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .header-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: var(--radius);
            color: white;
        }

        .header-section h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header-section p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .support-image {
            width: 100%;
            height: 200px;
            border-radius: var(--radius);
            margin: 20px 0;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 4rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        input, textarea, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: var(--radius);
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            background: white;
            box-shadow: 0 0 0 3px rgba(78, 137, 174, 0.1);
        }

        textarea {
            min-height: 140px;
            resize: vertical;
            line-height: 1.5;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: white;
            box-shadow: 0 4px 15px rgba(78, 137, 174, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78, 137, 174, 0.4);
        }

        .btn-secondary {
            background: white;
            border: 2px solid #e2e8f0;
            color: var(--muted);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
        }

        .messages-container {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .message {
            background: var(--glass);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            border-left: 4px solid var(--accent);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .message-meta {
            font-size: 0.85rem;
            color: var(--muted);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-content {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .comments-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .comment {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #cbd5e0;
        }

        .comment-meta {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 5px;
        }

        .comment-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .comment-input {
            flex: 1;
            padding: 10px 12px;
            font-size: 14px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: var(--muted);
        }

        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 16px;
            border-radius: var(--radius);
            margin: 15px 0;
            text-align: center;
            border-left: 4px solid #dc2626;
        }

        .success {
            background: #d1fae5;
            color: #059669;
            padding: 16px;
            border-radius: var(--radius);
            margin: 15px 0;
            text-align: center;
            border-left: 4px solid #059669;
        }

        .inspiration-quote {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: var(--radius);
            margin: 20px 0;
            text-align: center;
            font-style: italic;
            position: relative;
        }

        .quote-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .quote-prev {
            left: 10px;
        }

        .quote-next {
            right: 10px;
        }

        .admin-panel {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid #e2e8f0;
        }

        .floating-support {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            z-index: 1000;
        }

        .refresh-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .comment-btn {
            background: #e2e8f0;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--muted);
        }

        .comment-btn:hover {
            background: var(--accent);
            color: white;
        }

        .quote-counter {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .courage-message {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px;
            border-radius: var(--radius);
            margin: 15px 0;
            text-align: center;
            animation: fadeInOut 5s ease-in-out;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        .demo-message {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .firebase-status {
            padding: 10px;
            border-radius: var(--radius);
            margin: 10px 0;
            text-align: center;
            font-size: 0.9rem;
        }

        .firebase-connected {
            background: #d1fae5;
            color: #059669;
            border-left: 4px solid #059669;
        }

        .firebase-error {
            background: #fee2e2;
            color: #dc2626;
            border-left: 4px solid #dc2626;
        }

        .setup-guide {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: var(--radius);
            margin: 15px 0;
        }

        .setup-guide h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .setup-guide ol {
            margin-left: 20px;
            color: #856404;
        }

        .setup-guide li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Carte Principale -->
        <div class="card">
            <div class="header-section">
                <h1>💝 Sante Mantal Ayisyen</h1>
                <p>Yon espas pou kè w poze, san jijman, ak anpil respè</p>
            </div>

            <div class="support-image">
                🤝
            </div>

            <!-- Firebase Status -->
            <div id="firebase-status" class="firebase-status" style="display: none;">
                🔄 Nap teste koneksyon Firebase...
            </div>

            <!-- Guide Configuration Firebase -->
            <div class="setup-guide" id="setup-guide">
                <h4>📋 Enstriksyon Konfigirasyon Firebase</h4>
                <ol>
                    <li>Ale nan <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></li>
                    <li>Kreye yon pwojè nouvo oswa chwazi youn ki egziste deja</li>
                    <li>Nan "Build" → "Firestore Database" → Kreye baz done</li>
                    <li>Chwazi "Kommencer an mode test"</li>
                    <li>Nan "Paramètres" → "Paramètres du projet" → Kopye konfigirasyon yo</li>
                    <li>Kole yo nan kòd JavaScript la anba "CONFIGURATION FIREBASE"</li>
                </ol>
            </div>

            <!-- Citation inspirante -->
            <div class="inspiration-quote" id="daily-quote">
                <button class="quote-nav quote-prev" onclick="showPreviousQuote()">‹</button>
                <div id="quote-text">"Pale de sa w santi a, se premye etap gerizon"</div>
                <div class="quote-counter" id="quote-counter">1/10</div>
                <button class="quote-nav quote-next" onclick="showNextQuote()">›</button>
            </div>

            <!-- MESAJ KOURAJ -->
            <div id="courage-message" style="display: none;"></div>

            <!-- Formulaire de Message -->
            <form id="message-form">
                <div class="form-group">
                    <input type="text" id="pseudo" placeholder="👤 Chwazi yon non (si w vle)" maxlength="30">
                </div>

                <div class="form-group">
                    <select id="mood">
                        <option value="">🎭 Kijan kè w santi jodi a?</option>
                        <option value="sad">😢 Kè fè mal</option>
                        <option value="anxious">😰 Enkyetid ap kraze m</option>
                        <option value="lost">😵 Mwen pèdi chemen</option>
                        <option value="angry">😠 Kole wouj</option>
                        <option value="tired">😴 Fatige anpil</option>
                        <option value="hopeful">✨ Mwen gen espwa</option>
                        <option value="peaceful">😌 Kè poze</option>
                    </select>
                </div>

                <div class="form-group">
                    <textarea id="message" placeholder="💌 Koute, sa k pase nan kè w? Pa gen anyen ki two piti ni two gwo..." maxlength="1200"></textarea>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: #f8fafc; border-radius: var(--radius);">
                        <input type="checkbox" id="consent">
                        <span style="font-size: 0.9rem; color: var(--muted);">
                            Mwen konprann ke si gen yon sitiyasyon ijan, yo ka kontakte moun kapab ede m
                        </span>
                    </label>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    ✨ Voye mesaj la
                </button>
            </form>

            <div style="margin-top: 25px; padding: 20px; background: #fff3cd; border-radius: var(--radius); border-left: 4px solid #ffc107;">
                <p style="font-size: 0.9rem; color: #856404; text-align: center;">
                    <strong>🆘 Si kè w di w anyen pa ka vanse ankò:</strong><br>
                    <span style="color: #dc2626; font-weight: bold;">115 / 112</span> - Yo la pou ede w tout tan
                </p>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="card">
            <h3 style="margin-bottom: 20px; color: var(--accent);">📖 Mesaj kè yo</h3>
            
            <div id="messages-feed" class="messages-container">
                <div class="loading">⏳ Nap chaje mesaj yo...</div>
            </div>

            <!-- Panel Admin -->
            <div class="admin-panel">
                <h4 style="margin-bottom: 15px; color: var(--muted);">🔐 Espas Moderatè</h4>
                
                <div class="form-group">
                    <input type="password" id="admin-code" placeholder="🔒 Antre kòd la" style="margin-bottom: 12px;">
                    <button id="admin-btn" class="btn btn-secondary" style="width: 100%;">
                        👁️ Wè mesaj yo kap tann
                    </button>
                </div>

                <div id="admin-panel" style="display: none;">
                    <h5 style="margin-bottom: 15px; color: var(--accent);">⏳ Mesaj kap tann apwobasyon</h5>
                    
                    <!-- BOUTON AKTUALIZASYON -->
                    <div class="refresh-buttons">
                        <button onclick="loadPendingMessages()" class="btn btn-secondary btn-small">
                            🔄 Actualize
                        </button>
                        <button onclick="loadMessages()" class="btn btn-secondary btn-small">
                            📖 Wè mesaj piblik
                        </button>
                    </div>
                    
                    <div id="pending-messages"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bouton soutien flottant -->
    <div class="floating-support" onclick="openWhatsApp()">
        <span>🆘 Bezwen pale?</span>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // ========== CONFIGURATION FIREBASE ==========
        // 🔥 REMPLACE AVEC TES VRAIES CLÉS FIREBASE
       const firebaseConfig = {
  apiKey: "AIzaSyBS4tSSW7SIcLnGijYhrpmqSW7SvfbObA8",
  authDomain: "sante-mentale-hd.firebaseapp.com",
  projectId: "sante-mentale-hd",
  storageBucket: "sante-mentale-hd.firebasestorage.app",
  messagingSenderId: "583697521987",
  appId: "1:583697521987:web:0744c3865c05904bcee3f6"
};

        // Variables globales
        let db = null;
        let firebaseConnected = false;
        let currentQuoteIndex = 0;
        let allMessages = [];

        // Messages de démonstration (backup si Firebase pa konekte)
        const demoMessages = [
            {
                id: 'demo1',
                pseudo: 'Marie',
                mood: 'sad',
                text: 'Mwen santi mwen sèl ak chagren jodi a. Li difisil pou m kenbe fòm.',
                approvedAt: new Date(Date.now() - 2 * 60 * 60 * 1000),
                comments: [
                    {
                        pseudo: 'Zanmi',
                        text: 'Ou pa poukont ou Marie. Nou la pou w.',
                        createdAt: new Date(Date.now() - 1 * 60 * 60 * 1000)
                    }
                ]
            },
            {
                id: 'demo2',
                pseudo: 'Jean',
                mood: 'anxious',
                text: 'Enkyetid ap kraze m depi 2 semèn. Mwen pa ka dòmi byen.',
                approvedAt: new Date(Date.now() - 5 * 60 * 60 * 1000),
                comments: []
            },
            {
                id: 'demo3',
                pseudo: 'Sophie',
                mood: 'hopeful',
                text: 'Jodi a mwen deside chèche èd. Se yon premye etap enpòtan pou mwen.',
                approvedAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),
                comments: [
                    {
                        pseudo: 'Zanmi',
                        text: 'Bravo Sophie! Sa se yon gwo etap. 🎉',
                        createdAt: new Date(Date.now() - 23 * 60 * 60 * 1000)
                    }
                ]
            }
        ];

        // Messages de soutien
        const inspirationData = {
            quotes: [
                "Pale de sa w santi a, se premye etap gerizon",
                "Ou pa poukont ou nan batay sa a",
                "Chak jou w kanpe, se yon viktwa",
                "Kè poze fè lavi pi bèl",
                "Ou gen fòs andedan w, menm si w pa wè l",
                "Pèmèt tèt ou santi tout santiman ou",
                "Nou la pou tande w, san jijman",
                "Gerizon pran tan, men li posib",
                "Ou merite renmen ak respè",
                "Pa janm bay espwa, bon moman yo ap vini"
            ],
            courageMessages: [
                "Mèsi pou kouraj ou! 🌸 Kè poze ak fòs pou w.",
                "Vwa ou enpòtan anpil 💫 Mèsi pou pataje kè w.",
                "Mèsi pou konfyans ou 🌿 Ou pa poukont ou.",
                "Ou fè yon bon jan 👏 Kontinye kenbe fòm.",
                "Nou la pou ou 💝 Mèsi pou kouraj w.",
                "Kouray ou enspire moun 🎯 Mèsi anpil.",
                "Ou pi fò pase ou panse 💪 Mèsi pou pataj la."
            ]
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log("🚀 Lansman aplikasyon an...");
            initializeApp();
        });

        async function initializeApp() {
            setupEventListeners();
            await loadMessages();
            showQuote(currentQuoteIndex);
            
            // Teste Firebase après un délai
            setTimeout(() => {
                initializeFirebase();
            }, 1000);
        }

        // 🔥 INITIALISATION FIREBASE
        async function initializeFirebase() {
            try {
                const statusDiv = document.getElementById('firebase-status');
                statusDiv.style.display = 'block';
                statusDiv.className = 'firebase-status';
                statusDiv.innerHTML = '🔄 Nap teste koneksyon Firebase...';

                // Test si Firebase est déjà initialisé
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                db = firebase.firestore();
                
                // Tester la connexion avec un timeout
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout')), 5000)
                );
                
                const connectionPromise = db.collection('test').limit(1).get();
                
                await Promise.race([connectionPromise, timeoutPromise]);
                
                firebaseConnected = true;
                statusDiv.className = 'firebase-status firebase-connected';
                statusDiv.innerHTML = '✅ Firebase konekte! Mesaj yo ap sere nan baz done.';
                
                console.log("✅ Firebase konekte avèk siksè!");
                
                // Masque le guide de configuration
                document.getElementById('setup-guide').style.display = 'none';
                
                // Démarrer l'écoute en temps réel
                setupRealtimeListener();
                
                // Recharger les messages depuis Firebase
                await loadMessages();
                
            } catch (error) {
                console.error('❌ Erè koneksyon Firebase:', error);
                firebaseConnected = false;
                
                const statusDiv = document.getElementById('firebase-status');
                statusDiv.className = 'firebase-status firebase-error';
                statusDiv.innerHTML = '⚠️ Firebase pa konekte. Ap itilize sistèm demo. <button onclick="showSetupGuide()" style="background: none; border: none; color: #dc2626; text-decoration: underline; cursor: pointer;">Klike isit pou konfigure Firebase</button>';
                
                console.log("🔄 Itilize sistèm demo...");
            }
        }

        // 🔥 FONKSYON POU MONTRE GUIDE KONFIGIRASYON
        function showSetupGuide() {
            document.getElementById('setup-guide').style.display = 'block';
        }

        // 🔥 KOUTE CHANJMAN SI FIREBASE KONEKTE
        function setupRealtimeListener() {
            if (!firebaseConnected) return;
            
            try {
                db.collection('messages')
                    .where('status', '==', 'approved')
                    .orderBy('approvedAt', 'desc')
                    .onSnapshot((snapshot) => {
                        console.log("🔄 Mizajou an tan reyèl!");
                        allMessages = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            allMessages.push({ 
                                id: doc.id, 
                                ...data,
                                approvedAt: data.approvedAt ? data.approvedAt.toDate() : new Date()
                            });
                        });
                        displayMessages(allMessages);
                    }, (error) => {
                        console.error('Erè koute mesaj:', error);
                    });
            } catch (error) {
                console.error('Erè setup listener:', error);
            }
        }

        function setupEventListeners() {
            const form = document.getElementById('message-form');
            form.addEventListener('submit', handleSubmit);
            document.getElementById('admin-btn').addEventListener('click', handleAdminAuth);
        }

        // 🔥 SISTÈM NAVIGASYON POU QUOTES
        function showQuote(index) {
            const quoteText = document.getElementById('quote-text');
            const quoteCounter = document.getElementById('quote-counter');
            
            quoteText.textContent = `"${inspirationData.quotes[index]}"`;
            quoteCounter.textContent = `${index + 1}/${inspirationData.quotes.length}`;
            currentQuoteIndex = index;
        }

        function showNextQuote() {
            currentQuoteIndex = (currentQuoteIndex + 1) % inspirationData.quotes.length;
            showQuote(currentQuoteIndex);
        }

        function showPreviousQuote() {
            currentQuoteIndex = (currentQuoteIndex - 1 + inspirationData.quotes.length) % inspirationData.quotes.length;
            showQuote(currentQuoteIndex);
        }

        // 🔥 FONKSYON POU MONTRE MESAJ KOURAJ
        function showCourageMessage() {
            const courageMessage = inspirationData.courageMessages[
                Math.floor(Math.random() * inspirationData.courageMessages.length)
            ];
            
            const container = document.getElementById('courage-message');
            container.innerHTML = `
                <div class="courage-message">
                    <strong>${courageMessage}</strong>
                </div>
            `;
            container.style.display = 'block';
            
            setTimeout(() => {
                container.style.display = 'none';
            }, 5000);
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const pseudo = document.getElementById('pseudo').value.trim() || 'Zanmi';
            const mood = document.getElementById('mood').value;
            const text = document.getElementById('message').value.trim();
            const consent = document.getElementById('consent').checked;

            if (!text) {
                showError('Tanpri ekri yon ti kout pouvwa pou kè w.');
                return;
            }

            if (!consent) {
                if (!confirm('Eske w asire w pou kontinye san konsantman?')) return;
            }

            try {
                if (firebaseConnected) {
                    // 🔥 SI FIREBASE KONEKTE - SÈVI AK FIREBASE
                    await db.collection('messages_pending').add({
                        pseudo: pseudo,
                        mood: mood,
                        text: text,
                        consent: consent,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showCourageMessage();
                    document.getElementById('message-form').reset();
                    
                } else {
                    // 🔥 SI FIREBASE PA KONEKTE - SÈVI AK SISTÈM DEMO
                    const newMessage = {
                        id: 'demo-' + Date.now(),
                        pseudo: pseudo,
                        mood: mood,
                        text: text,
                        approvedAt: new Date(),
                        comments: []
                    };
                    
                    demoMessages.unshift(newMessage);
                    allMessages.unshift(newMessage);
                    
                    displayMessages(allMessages);
                    showCourageMessage();
                    document.getElementById('message-form').reset();
                    
                    showSuccess('💝 Mesaj ou an ajoute! (Sistèm demo)');
                }
                
            } catch (error) {
                console.error('Erè:', error);
                showError('Oops! Yon bagay pa bon. Eseye ankò.');
            }
        }

        async function loadMessages() {
            try {
                const container = document.getElementById('messages-feed');
                container.innerHTML = '<div class="loading">⏳ Nap chaje mesaj yo...</div>';
                
                if (firebaseConnected) {
                    // 🔥 SI FIREBASE KONEKTE - CHAJE SOT FIREBASE
                    const snapshot = await db.collection('messages')
                        .where('status', '==', 'approved')
                        .orderBy('approvedAt', 'desc')
                        .get();
                    
                    allMessages = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        allMessages.push({ 
                            id: doc.id, 
                            ...data,
                            approvedAt: data.approvedAt ? data.approvedAt.toDate() : new Date()
                        });
                    });
                    
                } else {
                    // 🔥 SI FIREBASE PA KONEKTE - SÈVI AK MESAJ DEMO
                    allMessages = [...demoMessages];
                }

                displayMessages(allMessages);
                
            } catch (error) {
                console.error('Erè chajman:', error);
                // 🔥 SI GEN ERÈ - SÈVI AK MESAJ DEMO
                allMessages = [...demoMessages];
                displayMessages(allMessages);
                showError('Pedi koneksyon. Ap itilize mesaj demo.');
            }
        }

        function displayMessages(messages) {
            const container = document.getElementById('messages-feed');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--muted);">
                        📝 Poko gen mesaj piblik isit.<br>
                        <small>Ou ka ekri premye a!</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => `
                <div class="message ${msg.id.includes('demo') ? 'demo-message' : ''}">
                    <div class="message-meta">
                        <span><strong>${escapeHtml(msg.pseudo)}</strong> • ${getMoodEmoji(msg.mood)}</span>
                        <span>${formatDate(msg.approvedAt)} ${msg.id.includes('demo') ? ' (Demo)' : ''}</span>
                    </div>
                    <div class="message-content">${escapeHtml(msg.text)}</div>
                    
                    <!-- SISTÈM KOMANTÈ -->
                    <div class="comments-section">
                        <div class="comment-form">
                            <input type="text" class="comment-input" placeholder="💬 Ekri yon komantè sipò..." 
                                   id="comment-input-${msg.id}">
                            <button class="btn btn-primary btn-small" onclick="addComment('${msg.id}')">
                                Voye
                            </button>
                        </div>
                        
                        ${msg.comments && msg.comments.length > 0 ? `
                            <div style="margin-top: 15px;">
                                ${msg.comments.map(comment => `
                                    <div class="comment">
                                        <div class="comment-meta">
                                            <strong>${escapeHtml(comment.pseudo)}</strong> • ${comment.createdAt ? formatDate(comment.createdAt) : 'Nouvo'}
                                        </div>
                                        <div>${escapeHtml(comment.text)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // 🔥 FONKSYON POU AJOUTE KOMANTÈ
        async function addComment(messageId) {
            const commentInput = document.getElementById(`comment-input-${messageId}`);
            const commentText = commentInput.value.trim();
            
            if (!commentText) {
                alert('Tanpri ekri yon komantè anvan w voye.');
                return;
            }

            try {
                const comment = {
                    pseudo: 'Zanmi',
                    text: commentText,
                    createdAt: new Date()
                };

                if (firebaseConnected && !messageId.includes('demo')) {
                    // 🔥 SI FIREBASE KONEKTE - AJOUTE NAN FIREBASE
                    const messageRef = db.collection('messages').doc(messageId);
                    await messageRef.update({
                        comments: firebase.firestore.FieldValue.arrayUnion(comment)
                    });
                } else {
                    // 🔥 SI FIREBASE PA KONEKTE - AJOUTE NAN DEMO
                    const message = allMessages.find(msg => msg.id === messageId);
                    if (message) {
                        if (!message.comments) message.comments = [];
                        message.comments.push(comment);
                        displayMessages(allMessages);
                    }
                }

                commentInput.value = '';
                showSuccess('💬 Komantè ou an ajoute!');
                
            } catch (error) {
                console.error('Erè ajoute komantè:', error);
                showError('Erè ajoute komantè a: ' + error.message);
            }
        }

        // 🔥 FONKSYON ADMIN
        async function handleAdminAuth() {
            const code = document.getElementById('admin-code').value;
            
            if (code !== "sante123") {
                showError('Kòd la pa bon. Eseye ankò.');
                return;
            }

            document.getElementById('admin-panel').style.display = 'block';
            await loadPendingMessages();
        }

        async function loadPendingMessages() {
            if (!firebaseConnected) {
                document.getElementById('pending-messages').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--muted);">
                        ⚠️ Firebase pa konekte. Panel admin pa disponib.
                    </div>
                `;
                return;
            }

            try {
                const snapshot = await db.collection('messages_pending').get();
                const pending = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    pending.push({ 
                        id: doc.id, 
                        ...data,
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date()
                    });
                });

                displayPendingMessages(pending);
                
            } catch (error) {
                console.error('Erè chajman atant:', error);
                showError('Pa chaje mesaj yo kap tann.');
            }
        }

        function displayPendingMessages(messages) {
            const container = document.getElementById('pending-messages');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--muted);">
                        ✅ Tout mesaj yo apwouve deja
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => `
                <div class="message" style="margin-bottom: 15px;">
                    <div class="message-meta">
                        ${escapeHtml(msg.pseudo)} • ${formatDate(msg.createdAt)}
                    </div>
                    <div class="message-content">${escapeHtml(msg.text)}</div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="approveMessage('${msg.id}')" class="btn btn-success btn-small">
                            ✅ Apwouve
                        </button>
                        <button onclick="rejectMessage('${msg.id}')" class="btn btn-danger btn-small">
                            ❌ Refize
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function approveMessage(id) {
            if (!firebaseConnected) {
                showError('Firebase pa konekte. Pa ka apwouve mesaj.');
                return;
            }

            try {
                const docRef = db.collection('messages_pending').doc(id);
                const doc = await docRef.get();
                
                if (!doc.exists) {
                    showError('Mesaj sa a pa la ankò.');
                    return;
                }
                
                const data = doc.data();

                await db.collection('messages').add({
                    pseudo: data.pseudo || 'Zanmi',
                    mood: data.mood || '',
                    text: data.text || '',
                    consent: data.consent || false,
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: data.createdAt || firebase.firestore.FieldValue.serverTimestamp(),
                    comments: [],
                    status: 'approved'
                });

                await docRef.delete();
                showSuccess('✅ Mesaj la apwouve! Li parèt kounye a.');
                await loadPendingMessages();
                
            } catch (error) {
                console.error('❌ Erè apwobasyon:', error);
                showError('Erè apwouve mesaj la: ' + error.message);
            }
        }

        async function rejectMessage(id) {
            if (!firebaseConnected) {
                showError('Firebase pa konekte. Pa ka refize mesaj.');
                return;
            }

            if (!confirm('Eske w sèten w vle retire mesaj sa a?')) return;

            try {
                await db.collection('messages_pending').doc(id).delete();
                await loadPendingMessages();
                showSuccess('✅ Mesaj la retire.');
            } catch (error) {
                console.error('Erè:', error);
                showError('Erè retire mesaj la.');
            }
        }

        function openWhatsApp() {
            const phone = '50949033260';
            const text = encodeURIComponent('Bonjou, mwen bezwen pale ak yon moun - Sante Mantal Ayisyen');
            window.open(`https://wa.me/${phone}?text=${text}`, '_blank');
        }

        // Utilitaires
        function getMoodEmoji(mood) {
            const emojis = {
                'sad': '😢', 'anxious': '😰', 'lost': '😵', 'angry': '😠',
                'tired': '😴', 'hopeful': '✨', 'peaceful': '😌'
            };
            return emojis[mood] || '🎭';
        }

        function formatDate(date) {
            if (!date) return 'Nouvo';
            return date.toLocaleDateString('ht-HT', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            const container = document.getElementById('messages-feed');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            container.prepend(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const container = document.getElementById('messages-feed');
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            container.prepend(successDiv);
            
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Exposer les fonctions globales
        window.approveMessage = approveMessage;
        window.rejectMessage = rejectMessage;
        window.openWhatsApp = openWhatsApp;
        window.loadMessages = loadMessages;
        window.loadPendingMessages = loadPendingMessages;
        window.addComment = addComment;
        window.showNextQuote = showNextQuote;
        window.showPreviousQuote = showPreviousQuote;
        window.showSetupGuide = showSetupGuide;
    </script>
</body>
</html>
