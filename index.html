<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sant√© Mentale HD ‚Äî Soutien √âmotionnel</title>
    <style>
        :root {
            --bg1: #FFF7F3;
            --bg2: #FFF2E8;
            --accent: #ff8fa3;
            --accent-2: #ffd29f;
            --muted: #6b6b6b;
            --card: #ffffff;
            --glass: rgba(255, 255, 255, 0.72);
            --radius: 16px;
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: linear-gradient(160deg, var(--bg1) 0%, var(--bg2) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #222;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: 0 8px 30px rgba(50, 50, 70, 0.08);
            padding: 25px;
            backdrop-filter: blur(10px);
        }

        header {
            text-align: center;
            margin-bottom: 25px;
        }

        header h1 {
            color: #ff6b6b;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        header p {
            color: var(--muted);
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--radius);
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 143, 163, 0.1);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 143, 163, 0.3);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: var(--muted);
        }

        .btn-emergency {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .messages-container {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .message {
            background: var(--glass);
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
        }

        .message-meta {
            font-size: 0.85rem;
            color: var(--muted);
            margin-bottom: 8px;
            display: flex;
            justify-content: between;
            gap: 10px;
        }

        .message-content {
            margin-bottom: 10px;
        }

        .comments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .comment {
            background: rgba(0, 0, 0, 0.03);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .admin-panel {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(0, 0, 0, 0.1);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }

        .error {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: var(--radius);
            margin: 10px 0;
            text-align: center;
        }

        .success {
            background: #e6f7e6;
            color: #27ae60;
            padding: 15px;
            border-radius: var(--radius);
            margin: 10px 0;
            text-align: center;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .floating-hearts {
            position: fixed;
            bottom: 20px;
            right: 20px;
            pointer-events: none;
        }

        .heart {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #ff8fa3, #ffd29f);
            border-radius: 50%;
            margin: 5px;
            animation: float 6s infinite;
            opacity: 0.3;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .heart:nth-child(2) { animation-delay: 2s; }
        .heart:nth-child(3) { animation-delay: 4s; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Carte Principale -->
        <div class="card">
            <header>
                <h1>üåà Sant√© Mentale HD</h1>
                <p>Yon espas an sekirite pou pataje sa w santi anonimman</p>
            </header>

            <!-- Section Citation -->
            <div class="form-group">
                <div style="display: flex; justify-content: between; align-items: center; gap: 15px;">
                    <div style="flex: 1;">
                        <strong>üí´ Mesaj o aza jodi a</strong>
                        <div id="daily-quote" style="margin-top: 5px; color: var(--muted); font-style: italic;">
                            "Pale sou soufrans ou, se deja komanse geri"
                        </div>
                    </div>
                    <button id="new-quote" class="btn btn-secondary">üîÑ Nouvo</button>
                </div>
            </div>

            <!-- Formulaire de Message -->
            <form id="message-form">
                <div class="form-group">
                    <input type="text" id="pseudo" placeholder="üë§ Chwazi yon pseudo (opsyon√®l)" maxlength="30">
                </div>

                <div class="form-group">
                    <select id="mood">
                        <option value="">üòê Chwazi kijan ou santi w</option>
                        <option value="sad">üò¢ Tris</option>
                        <option value="anxious">üò∞ Anksye</option>
                        <option value="lost">üòµ P√®di</option>
                        <option value="angry">üò† Fache</option>
                        <option value="happy">üòä Kontan</option>
                    </select>
                </div>

                <div class="form-group">
                    <textarea id="message" placeholder="‚úçÔ∏è Ekri sa w santi... Pa janm pataje enf√≤masyon p√®son√®l." maxlength="1000"></textarea>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="consent">
                        <span style="font-size: 0.9rem; color: var(--muted);">
                            Mwen dak√≤ ke mesaj mwen ka itilize pou al√®t si li par√®t ijan
                        </span>
                    </label>
                </div>

                <div id="typing-encouragement" style="text-align: center; color: #ba68c8; font-style: italic; margin: 10px 0; opacity: 0; transition: opacity 0.3s;"></div>

                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px;">
                    <button type="submit" class="btn btn-primary">
                        üì§ Pibliye anonimman
                    </button>
                    <button type="button" id="whatsapp-btn" class="btn btn-emergency">
                        üö® M bezwen pale
                    </button>
                </div>
            </form>

            <div style="margin-top: 20px; padding: 15px; background: rgba(255, 107, 107, 0.1); border-radius: var(--radius);">
                <p style="font-size: 0.9rem; color: var(--muted); text-align: center;">
                    <strong>üìû Si w an danje, rele:</strong><br>
                    <span style="color: #ff6b6b; font-weight: bold;">115 / 112</span> - S√®vis Ijans
                </p>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="card">
            <h3 style="margin-bottom: 20px;">üìù Fil mesaj yo</h3>
            
            <div id="messages-feed" class="messages-container">
                <div class="loading">‚è≥ Chajman mesaj yo...</div>
            </div>

            <!-- Panel Admin -->
            <div class="admin-panel">
                <h4 style="margin-bottom: 15px;">üîß Admin / Mod√©ration</h4>
                
                <div class="form-group">
                    <input type="password" id="admin-code" placeholder="üîë Antre k√≤d admin" style="margin-bottom: 10px;">
                    <button id="load-pending" class="btn btn-secondary" style="width: 100%;">
                        üì• Chaje mesaj an atant
                    </button>
                </div>

                <div id="pending-section" style="display: none;">
                    <h5 style="margin-bottom: 15px;">‚è≥ Mesaj an atant</h5>
                    <div id="pending-messages"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- C≈ìurs flottants -->
    <div class="floating-hearts">
        <div class="heart"></div>
        <div class="heart"></div>
        <div class="heart"></div>
    </div>

    <!-- Modal de Confirmation -->
    <div id="confirmation-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 id="confirm-title" style="margin-bottom: 15px;">M√®si !</h3>
            <p id="confirm-message" style="margin-bottom: 20px; color: var(--muted);">
                Nou te resevwa mesaj ou. Pran swen t√®t ou.
            </p>
            <button id="close-confirm" class="btn btn-primary">F√®men</button>
        </div>
    </div>

    <!-- Modal d'Urgence -->
    <div id="emergency-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e); color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">üö® ATANSYON</h3>
                <p style="margin-bottom: 10px;">Mesaj ou a gen mo ki endike w ka an danje.</p>
                <p><strong>Tanpri kontakte √®d imedyatman:</strong></p>
                <p style="margin: 10px 0;">üìû <strong>115 / 112</strong> - S√®vis Ijans</p>
                <p>üí¨ <strong>WhatsApp: 50949033260</strong></p>
            </div>
            <p style="color: var(--muted); margin-bottom: 20px;">Ou pa poukont ou - nou la pou ede w!</p>
            <button id="close-emergency" class="btn btn-secondary">Mwen konprann</button>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ========== CONFIGURATION SUPABASE ==========
        // CR√âEZ UN NOUVEAU PROJET SUR supabase.com ET REMPLACEZ CES CL√âS
        const SUPABASE_URL = "https://ldtdahuuxyplwemczxzd.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkdGRhaHV1eHlwbHdlbWN6eHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMDgzOTEsImV4cCI6MjA3NjU4NDM5MX0.R9jTAprmQ4HwAmGV_NQqyVwvP1VXtCU5V9WSBV9w36U";

        // Initialisation Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Configuration
        const ADMIN_CODE = "sante123";
        const DANGEROUS_WORDS = ['mwen vle mouri', 'f√® t√®t mwen mal', 'sui', 'suicide', 'mwen pa kapab ank√≤'];

        // Donn√©es d'inspiration
        const inspirationData = {
            quotes: [
                "Pale sou soufrans ou, se deja komanse geri",
                "Emosyon ou merite yo tande",
                "Pran swen sante mantal ou se yon akt kouray",
                "Ou pa poukont ou nan chemen sa a",
                "Chak jou se yon nouvo koumansman",
                "Santi w mal se n√≤mal, ou pa f√®b",
                "P√®m√®t t√®t ou santi tout santiman ou"
            ],
            encouragements: [
                "M√®si paske ou pataje üå∏",
                "Vwa ou gen val√® üí´",
                "Pran yon ti repo üåø",
                "Kontinye ekri üëè",
                "Ou gen kouray üíù"
            ]
        };

        // √âl√©ments DOM
        const elements = {
            form: document.getElementById('message-form'),
            messagesFeed: document.getElementById('messages-feed'),
            pendingSection: document.getElementById('pending-section'),
            pendingMessages: document.getElementById('pending-messages'),
            confirmationModal: document.getElementById('confirmation-modal'),
            emergencyModal: document.getElementById('emergency-modal')
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            setupEventListeners();
            await loadMessages();
            showRandomQuote();
        }

        function setupEventListeners() {
            // Formulaire
            elements.form.addEventListener('submit', handleSubmit);
            
            // Textarea encouragement
            document.getElementById('message').addEventListener('focus', showTypingEncouragement);
            
            // Boutons
            document.getElementById('new-quote').addEventListener('click', showRandomQuote);
            document.getElementById('whatsapp-btn').addEventListener('click', openWhatsApp);
            document.getElementById('load-pending').addEventListener('click', handleAdminAuth);
            
            // Modals
            document.getElementById('close-confirm').addEventListener('click', () => hideModal('confirmation-modal'));
            document.getElementById('close-emergency').addEventListener('click', () => hideModal('emergency-modal'));
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const pseudo = document.getElementById('pseudo').value.trim() || 'Anonim';
            const mood = document.getElementById('mood').value;
            const text = document.getElementById('message').value.trim();
            const consent = document.getElementById('consent').checked;

            // Validation
            if (!text) {
                showError('Tanpri ekri yon mesaj.');
                return;
            }

            if (!consent) {
                if (!confirm('Ou pa dak√≤ konsantman an. √àske w vle kontinye?')) return;
            }

            // V√©rification urgence
            if (checkForEmergency(text)) {
                showEmergencyAlert();
                if (!confirm('‚ö†Ô∏è Mesaj ou a gen mo ki endike detres. √àske w vle kontinye?')) return;
            }

            try {
                // Envoyer √† Supabase
                const { data, error } = await supabase
                    .from('messages_pending')
                    .insert([{
                        pseudo,
                        mood,
                        text,
                        consent,
                        status: 'pending',
                        created_at: new Date().toISOString()
                    }]);

                if (error) throw error;

                // Succ√®s
                showConfirmation();
                elements.form.reset();
                
            } catch (error) {
                console.error('Er√®:', error);
                showError('Er√® anvoye mesaj. Tcheke koneksyon w.');
            }
        }

        async function loadMessages() {
            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (error) throw error;

                displayMessages(messages || []);
                
            } catch (error) {
                console.error('Er√® chajman:', error);
                elements.messagesFeed.innerHTML = '<div class="error">‚ùå Er√® chajman mesaj</div>';
            }
        }

        function displayMessages(messages) {
            if (messages.length === 0) {
                elements.messagesFeed.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--muted);">
                        üìù Pa gen mesaj pou kounye a.<br>
                        Ou ka pataje premye mesaj ou!
                    </div>
                `;
                return;
            }

            elements.messagesFeed.innerHTML = messages.map(msg => `
                <div class="message">
                    <div class="message-meta">
                        <span>${escapeHtml(msg.pseudo)}</span>
                        <span>‚Ä¢</span>
                        <span>${getMoodEmoji(msg.mood)} ${msg.mood || ''}</span>
                        <span>‚Ä¢</span>
                        <span>${formatDate(msg.created_at)}</span>
                    </div>
                    <div class="message-content">${escapeHtml(msg.text)}</div>
                    ${msg.comments && msg.comments.length > 0 ? `
                        <div class="comments-section">
                            <strong>üí¨ K√≤mant√® (${msg.comments.length}):</strong>
                            ${msg.comments.map(comment => `
                                <div class="comment">
                                    <strong>${escapeHtml(comment.author)}:</strong> 
                                    ${escapeHtml(comment.text)}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        async function handleAdminAuth() {
            const code = document.getElementById('admin-code').value;
            
            if (code !== ADMIN_CODE) {
                showError('K√≤d admin pa k√≤r√®k!');
                return;
            }

            elements.pendingSection.style.display = 'block';
            await loadPendingMessages();
        }

        async function loadPendingMessages() {
            try {
                const { data: pending, error } = await supabase
                    .from('messages_pending')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                displayPendingMessages(pending || []);
                
            } catch (error) {
                console.error('Er√® chajman atant:', error);
                showError('Er√® chajman mesaj an atant');
            }
        }

        function displayPendingMessages(messages) {
            if (messages.length === 0) {
                elements.pendingMessages.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--muted);">
                        ‚úÖ Pa gen mesaj an atant
                    </div>
                `;
                return;
            }

            elements.pendingMessages.innerHTML = messages.map(msg => `
                <div class="message" style="margin-bottom: 15px;">
                    <div class="message-meta">
                        ${escapeHtml(msg.pseudo)} ‚Ä¢ ${formatDate(msg.created_at)}
                    </div>
                    <div class="message-content">${escapeHtml(msg.text)}</div>
                    ${checkForEmergency(msg.text) ? '<div style="color: red; font-size: 0.8rem; margin-top: 5px;">üö® DET√àS DETEKTE</div>' : ''}
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button onclick="approveMessage('${msg.id}')" class="btn btn-primary" style="padding: 8px 15px; font-size: 0.9rem;">
                            ‚úÖ Apwouve
                        </button>
                        <button onclick="rejectMessage('${msg.id}')" class="btn btn-secondary" style="padding: 8px 15px; font-size: 0.9rem;">
                            ‚ùå Refize
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function approveMessage(id) {
            try {
                // R√©cup√©rer le message en attente
                const { data: pendingMsg, error: fetchError } = await supabase
                    .from('messages_pending')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (fetchError) throw fetchError;

                // Cr√©er le message approuv√©
                const { error: insertError } = await supabase
                    .from('messages')
                    .insert([{
                        ...pendingMsg,
                        approved_at: new Date().toISOString(),
                        comments: []
                    }]);

                if (insertError) throw insertError;

                // Supprimer l'attente
                const { error: deleteError } = await supabase
                    .from('messages_pending')
                    .delete()
                    .eq('id', id);

                if (deleteError) throw deleteError;

                // Recharger
                await loadMessages();
                await loadPendingMessages();
                showSuccess('Mesaj apwouve av√®k siks√®!');
                
            } catch (error) {
                console.error('Er√® apwobasyon:', error);
                showError('Er√® apwobasyon mesaj');
            }
        }

        async function rejectMessage(id) {
            if (!confirm('√àske w s√®ten w vle refize mesaj sa a?')) return;

            try {
                const { error } = await supabase
                    .from('messages_pending')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                await loadPendingMessages();
                showSuccess('Mesaj refize.');
                
            } catch (error) {
                console.error('Er√® rej√®:', error);
                showError('Er√® refize mesaj');
            }
        }

        // Utilitaires
        function showRandomQuote() {
            const quote = inspirationData.quotes[Math.floor(Math.random() * inspirationData.quotes.length)];
            document.getElementById('daily-quote').textContent = `"${quote}"`;
        }

        function showTypingEncouragement() {
            const encouragement = inspirationData.encouragements[Math.floor(Math.random() * inspirationData.encouragements.length)];
            const el = document.getElementById('typing-encouragement');
            el.textContent = encouragement;
            el.style.opacity = '1';
            setTimeout(() => el.style.opacity = '0', 3000);
        }

        function checkForEmergency(text) {
            return DANGEROUS_WORDS.some(word => text.toLowerCase().includes(word));
        }

        function showConfirmation() {
            const encouragement = inspirationData.encouragements[Math.floor(Math.random() * inspirationData.encouragements.length)];
            document.getElementById('confirm-title').textContent = encouragement;
            showModal('confirmation-modal');
        }

        function showEmergencyAlert() {
            showModal('emergency-modal');
        }

        function openWhatsApp() {
            const phone = '50949033260';
            const text = encodeURIComponent('Bonjou, mwen santi mwen bezwen pale ak yon moun ‚Äî Sant√© Mentale HD');
            window.open(`https://wa.me/${phone}?text=${text}`, '_blank');
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showError(message) {
            const existingError = elements.messagesFeed.querySelector('.error');
            if (existingError) existingError.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            elements.messagesFeed.prepend(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            elements.messagesFeed.prepend(successDiv);
            
            setTimeout(() => successDiv.remove(), 3000);
        }

        function getMoodEmoji(mood) {
            const emojis = {
                'sad': 'üò¢', 'anxious': 'üò∞', 'lost': 'üòµ', 'angry': 'üò†', 'happy': 'üòä'
            };
            return emojis[mood] || 'üòê';
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Exposer les fonctions globales
        window.approveMessage = approveMessage;
        window.rejectMessage = rejectMessage;
    </script>
</body>
</html>
